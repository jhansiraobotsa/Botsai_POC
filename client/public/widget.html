<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vyoma AI Chatbot Widget</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      height: 100vh;
      overflow: hidden;
      --header-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --header-color: #667eea;
      --user-bubble-color: #6366f1; 
      --font-size: 14px;
      --border-radius: 8px;
      --show-avatar: flex;
      --show-powered-by: block;
    }

    .widget-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--header-bg);
    }

    .widget-header {
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .widget-avatar {
      width: 45px;
      height: 45px;
      background: white;
      border-radius: 50%;
      display: var(--show-avatar);
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .widget-avatar i {
      color: var(--header-color);
      font-size: 22px;
    }

    .widget-info {
      flex: 1;
      color: white;
    }

    .widget-info h3 {
      font-size: calc(var(--font-size) + 2px);
      font-weight: 600;
      margin-bottom: 3px;
    }

    .widget-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      opacity: 0.95;
    }

    .widget-controls {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    .widget-control-btn {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 14px;
    }

    .widget-control-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }

    .widget-control-btn:active {
      transform: scale(0.95);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #4ade80;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .widget-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: linear-gradient(to bottom, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.1) 100%);
    }

    .message {
      margin-bottom: 16px;
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-bot {
      justify-content: flex-start;
    }

    .message-user {
      justify-content: flex-end;
    }

    .message-bubble {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      word-wrap: break-word;
      line-height: 1.6;
      font-size: var(--font-size);
    }

    .message-bot .message-bubble {
      background: white;
      color: #1e293b;
      border-bottom-left-radius: 4px;
    }

    .message-user .message-bubble {
      background: var(--user-bubble-color, #6366f1); /* Fallback to default */
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message-bubble strong {
      font-weight: 700;
      color: inherit;
    }

    .message-bubble em {
      font-style: italic;
    }

    .message-bubble ul, .message-bubble ol {
      margin: 8px 0;
      padding-left: 20px;
    }

    .message-bubble li {
      margin: 4px 0;
    }

    .message-bubble p {
      margin: 8px 0;
    }

    .message-bubble p:first-child {
      margin-top: 0;
    }

    .message-bubble p:last-child {
      margin-bottom: 0;
    }

    .message-bubble code {
      background: rgba(0, 0, 0, 0.05);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .message-bot .message-bubble code {
      background: #f1f5f9;
      color: #0f172a;
    }

    .message-user .message-bubble code {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .message-bubble pre {
      background: #1e293b;
      color: #10b981;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      margin: 8px 0;
    }

    .message-bubble pre code {
      background: transparent;
      padding: 0;
      color: inherit;
    }

    .message-time {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 4px;
      display: block;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
      background: white;
      border-radius: var(--border-radius);
      width: fit-content;
      border-bottom-left-radius: 4px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: #94a3b8;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }

    .widget-input-area {
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .input-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .widget-input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 24px;
      font-size: var(--font-size);
      outline: none;
      transition: all 0.2s;
    }

    .widget-input:focus {
      border-color: var(--header-color);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .send-button {
      width: 44px;
      height: 44px;
      background: var(--header-color);
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .send-button:hover {
      transform: scale(1.05);
    }

    .send-button:active {
      transform: scale(0.95);
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .widget-footer {
      padding: 8px 20px;
      text-align: center;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      background: rgba(0, 0, 0, 0.1);
      display: var(--show-powered-by);
    }

    .widget-footer a {
      color: white;
      text-decoration: none;
      font-weight: 600;
    }

    .widget-footer a:hover {
      text-decoration: underline;
    }

    .widget-messages::-webkit-scrollbar {
      width: 6px;
    }

    .widget-messages::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
    }

    .widget-messages::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }

    .widget-messages::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .quick-replies {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .quick-reply-btn {
      padding: 8px 14px;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(5px);
    }

    .quick-reply-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <div class="widget-container" id="chatWidget">
    <!-- Header -->
    <div class="widget-header">
      <div class="widget-avatar" id="widgetAvatar">
        <i class="fas fa-robot"></i>
      </div>
      <div class="widget-info">
        <h3 id="widgetTitle">Vyoma AI</h3>
        <div class="widget-status">
          <span class="status-dot"></span>
          <span>Online â€¢ Ready to help</span>
        </div>
      </div>
      <div class="widget-controls">
        <button class="widget-control-btn" id="minimizeBtn" title="Minimize" onclick="minimizeWidget()">
          <i class="fas fa-minus"></i>
        </button>
        <button class="widget-control-btn" id="closeBtn" title="Close" onclick="closeWidget()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- Messages Area -->
    <div class="widget-messages" id="messagesContainer">
      <div class="message message-bot">
        <div class="message-bubble">
          <div id="welcomeMessage">Hello! ðŸ‘‹ I'm your AI assistant. How can I help you today?</div>
          <span class="message-time">Just now</span>
        </div>
      </div>
      
      <!-- Quick Replies -->
      <div class="quick-replies" id="quickReplies">
        <!-- Dynamic quick replies will be inserted here -->
      </div>
    </div>

    <!-- Input Area -->
    <div class="widget-input-area">
      <div class="input-container">
        <input 
          type="text" 
          class="widget-input" 
          id="messageInput" 
          placeholder="Type your message..."
          onkeypress="handleKeyPress(event)"
        >
        <button class="send-button" id="sendButton" onclick="sendMessage()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>

    <!-- Footer -->
    <div class="widget-footer" id="widgetFooter">
      Powered by <a href="https://vyomai.techraq.com/" target="_blank">Vyoma.ai</a>
    </div>
  </div>

  <script>
    // Get parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const chatbotId = urlParams.get('id') || 'demo';
    const apiUrl = urlParams.get('api') || 'https://vyomai.techraq.com';
    
    // Get ALL customization parameters from URL
    const agentName = urlParams.get('agent_name') || 'Vyoma AI';
    const headerColor = urlParams.get('header_color') || '#3B82F6';
    const userBubbleColor = urlParams.get('user_bubble_color') || '#6366f1';
    const fontSize = urlParams.get('font_size') || '14';
    const borderRadius = urlParams.get('border_radius') || '8';
    const showAvatar = urlParams.get('show_avatar') !== 'false';
    const welcomeMessage = urlParams.get('welcome_message') || 'Hello! ðŸ‘‹ I\'m your AI assistant. How can I help you today?';
    const inputPlaceholder = urlParams.get('input_placeholder') || 'Type your message...';
    const suggestedQuestions = JSON.parse(urlParams.get('suggested_questions') || '[]');
    const quickReplies = JSON.parse(urlParams.get('quick_replies') || '[]');
    const typingIndicator = urlParams.get('typing_indicator') !== 'false';
    const showPoweredBy = urlParams.get('show_powered_by') !== 'false';
    const responseStyle = urlParams.get('response_style') || '';
    const responseTone = urlParams.get('response_tone') || '';
    const fallbackMessage = urlParams.get('fallback_message') || 'I\'m not sure I understand. Could you please rephrase your question?';
    const chatLanguage = urlParams.get('chat_language') || 'English';

    let sessionId = '';
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');

    // Apply ALL customization on load
    function applyCustomization() {
      console.log('Applying customization:', {
        agentName,
        headerColor,
        userBubbleColor,
        fontSize,
        borderRadius,
        showAvatar,
        welcomeMessage,
        inputPlaceholder,
        suggestedQuestions,
        quickReplies,
        typingIndicator,
        showPoweredBy,
        responseStyle,
        responseTone
      });

      // Set CSS custom properties - FIXED: Ensure proper color format
      document.documentElement.style.setProperty('--header-color', validateColor(headerColor));
      document.documentElement.style.setProperty('--user-bubble-color', validateColor(userBubbleColor));
      document.documentElement.style.setProperty('--font-size', `${fontSize}px`);
      document.documentElement.style.setProperty('--border-radius', `${borderRadius}px`);
      document.documentElement.style.setProperty('--show-avatar', showAvatar ? 'flex' : 'none');
      document.documentElement.style.setProperty('--show-powered-by', showPoweredBy ? 'block' : 'none');

      // Set header background gradient with validated colors
      const validHeaderColor = validateColor(headerColor);
      document.querySelector('.widget-container').style.background = 
        `linear-gradient(135deg, ${validHeaderColor} 0%, ${adjustColor(validHeaderColor, -20)} 100%)`;

      // Set agent name
      document.getElementById('widgetTitle').textContent = agentName;

      // Set welcome message
      document.getElementById('welcomeMessage').textContent = welcomeMessage;

      // Set input placeholder
      messageInput.placeholder = inputPlaceholder;

      // Populate quick replies
      const quickRepliesContainer = document.getElementById('quickReplies');
      quickRepliesContainer.innerHTML = '';

      // Use quick_replies if available, otherwise use suggested_questions
      const repliesToShow = quickReplies.length > 0 ? quickReplies : suggestedQuestions;
      
      if (repliesToShow.length > 0) {
        repliesToShow.forEach(reply => {
          const button = document.createElement('button');
          button.className = 'quick-reply-btn';
          button.textContent = reply;
          button.onclick = () => sendQuickReply(reply);
          quickRepliesContainer.appendChild(button);
        });
      } else {
        quickRepliesContainer.style.display = 'none';
      }

      console.log('Customization applied successfully');
      console.log('User Bubble Color Applied:', validateColor(userBubbleColor));
    }

    // Utility function to validate and format color
    function validateColor(color) {
      if (!color || color.trim() === '') return '#6366f1';
      
      // If it's already a valid hex color, return it
      if (/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(color)) {
        return color;
      }
      
      // If it's a named color or invalid, return default
      return '#6366f1';
    }

    // Utility function to adjust color brightness
    function adjustColor(color, percent) {
      const validColor = validateColor(color);
      const num = parseInt(validColor.replace("#",""), 16);
      const amt = Math.round(2.55 * percent);
      const R = Math.min(255, Math.max(0, (num >> 16) + amt));
      const G = Math.min(255, Math.max(0, (num >> 8 & 0x00FF) + amt));
      const B = Math.min(255, Math.max(0, (num & 0x0000FF) + amt));
      return "#" + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
    }

    function addMessage(content, sender = 'bot') {
      // Remove quick replies after first user message
      const quickReplies = document.getElementById('quickReplies');
      if (quickReplies && sender === 'user') {
        quickReplies.style.display = 'none';
      }

      const messageDiv = document.createElement('div');
      messageDiv.className = `message message-${sender}`;
      
      const time = new Date().toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit' 
      });
      
      // Format message content
      let formattedContent = content;
      if (sender === 'bot') {
        formattedContent = formattedContent.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        formattedContent = formattedContent.replace(/\*(.+?)\*/g, '<em>$1</em>');
        formattedContent = formattedContent.replace(/`(.+?)`/g, '<code>$1</code>');
        formattedContent = formattedContent.replace(/\n/g, '<br>');
      }
      
      messageDiv.innerHTML = `
        <div class="message-bubble">
          <div>${formattedContent}</div>
          <span class="message-time">${time}</span>
        </div>
      `;
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function showTypingIndicator() {
      if (!typingIndicator) return;
      
      const typingDiv = document.createElement('div');
      typingDiv.className = 'message message-bot';
      typingDiv.id = 'typing-indicator';
      typingDiv.innerHTML = `
        <div class="typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      `;
      messagesContainer.appendChild(typingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function removeTypingIndicator() {
      const typingIndicator = document.getElementById('typing-indicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      // Add user message
      addMessage(message, 'user');
      messageInput.value = '';
      sendButton.disabled = true;

      // Show typing indicator
      showTypingIndicator();

      try {
        const response = await fetch(`${apiUrl}/api/v1/rag/chat`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'accept': 'application/json'
          },
          body: JSON.stringify({
            chatbot_id: chatbotId,
            query: message,
            session_id: sessionId || ''
          })
        });

        if (!response.ok) {
          throw new Error(`API returned ${response.status}`);
        }

        const data = await response.json();
        
        // Update session ID if this is the first message
        if (!sessionId && data.session_id) {
          sessionId = data.session_id;
        }

        removeTypingIndicator();
        
        // Use fallback message if no response
        const botResponse = data.answer || data.response || data.message || fallbackMessage;
        addMessage(botResponse, 'bot');
      } catch (error) {
        console.error('Error sending message:', error);
        removeTypingIndicator();
        addMessage(fallbackMessage, 'bot');
      } finally {
        sendButton.disabled = false;
        messageInput.focus();
      }
    }

    function sendQuickReply(message) {
      messageInput.value = message;
      sendMessage();
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // Widget control functions
    function minimizeWidget() {
      if (window.parent !== window) {
        window.parent.postMessage({ type: 'vyoma-minimize' }, '*');
      }
    }

    function closeWidget() {
      if (window.parent !== window) {
        window.parent.postMessage({ type: 'vyoma-close' }, '*');
      }
    }

    // Function to update user bubble color dynamically (if needed later)
    function updateUserBubbleColor(newColor) {
      const validColor = validateColor(newColor);
      document.documentElement.style.setProperty('--user-bubble-color', validColor);
      console.log('User bubble color updated to:', validColor);
    }

    // Initialize
    applyCustomization();
    messageInput.focus();
    
    console.log('Vyoma AI Widget initialized with customization');
    console.log('Agent Name:', agentName);
    console.log('Header Color:', headerColor);
    console.log('User Bubble Color:', userBubbleColor);
    console.log('Quick Replies:', quickReplies);
    console.log('Suggested Questions:', suggestedQuestions);
  </script>
</body>
</html>